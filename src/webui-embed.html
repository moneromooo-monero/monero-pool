<!doctype html>
<html>
    <head>
        <title>Townforge/Monero merge mining pool</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdn.rawgit.com/Chalarangelo/mini.css/v3.0.1/dist/mini-default.min.css">
        <style>
            body {
                font-family: "Courier New", Courier, monospace;
            }
            header {
                font-size: larger;
                font-weight: bold;
                padding-bottom: 1em;
            }
            table {
                padding-bottom: 1em;
            }
            td {
                vertical-align: top;
                white-space: nowrap;
            }
            td:last-child {
                white-space: unset;
            }
            .miner {
                display: none;
            }
            .howto {
                display: none;
            }
            #address {
                min-width: 10ch;
                max-width: 10ch;
                overflow: hidden;
                border-bottom: 1px dashed black;
                text-overflow: ellipsis;
                white-space: nowrap;
                word-wrap: unset;
            }
            #address:focus {
                outline: 0px solid transparent;
                text-overflow: initial;
                white-space: initial;
                word-wrap: break-word;
            }
            .card.miner {
              --card-back-color: #0094a1;
              --card-fore-color: #f8f8f8;
              --card-border-color: #a71a1a;
            }
            .poolcol {
              background: #0094a1;
              color: #ffffff;
              padding: 0.4rem;
            }
        </style>
        <script>
            if (window.trustedTypes && window.trustedTypes.createPolicy) {
                window.trustedTypes.createPolicy('default', {
                    createHTML: (string, sink) => string
                });
            }
        </script>
        <script>
            function show_hide(id)
            {
                var e = document.getElementById(id)
                if (e.style.display == "none" || e.style.display == "")
                    e.style.display = "block";
                else
                    e.style.display = "none";
            }
        </script>
    </head>
    <body>
        <h1>Townforge/Monero merge mining pool</h1>
        <div class="card warning fluid">
          <p class="doc">Currently in TESTING mode. All Townforge mined here is TESTNET. Pool will restart regularly.</p>
        </div>
        <div class="card fluid">
          <p class="doc">
            <a href="https://townforge.net/">Townforge</a>
            is a fork of Monero, with a builtin multiplayer city building game. All game actions are performed
            by on chain transactions, making it a fully decentralized game where you can earn cryptocurrency by playing.
            3D voxel world on Linux/Windows/Mac.
          </p>
        </div>
        <div class="card fluid">
          <h3 class="doc button" onclick="js:show_hide('howto')"> >> How to mine ?</h3>
          <div class="howto" id="howto">
            <p class="doc">
            This pool allows you to mine both Townforge and Monero at the same time with no extra energy expenditure.
            Just point your miner (eg, <a href="https://github.com/xmrig/xmrig/releases">xmrig</a>)
            at the pool port as you'd do with any other pool. The only difference
            is that you can append a Townforge address to your Monero address, with a / separator, eg:
            <pre>xmrig --coin monero -o pool.townforge.net:<span id="pool_port"></span> -u 4xxxx/TF1M....</pre>
            </p>
            <p class="doc">You can also set just a Monero address or just a Townforge address, if you want to mine a single chain.</p>
            <p class="doc">
              Note that merge mining links your Townforge and Monero addresses. If this is a problem for you, use a
              subaddress you only use for mining.
            </p>
          </div>
        </div>


        <div class="row" style="--universal-padding: 0.25rem">
            <div class="fluid col-sm">
                <table class="striped" style="max-height: 8000px; overflow: hidden">
                    <caption class="poolcol">Pool</caption>
                    <tbody>
                        <tr><td data-label="Pool hashrate">Pool hashrate: </td><td id="pool_hashrate"></td></tr>
                        <tr><td data-label="Last template">Last template: </td><td id="last_template_fetched"></td></tr>
                        <tr><td data-label="Pool fee">Pool fee: </td><td id="pool_fee"></td></tr>
                        <tr><td data-label="Pool port">Pool port: </td><td id="pool_port"></td></tr>
                        <!-- <tr><td data-label="Pool SSL port">Pool SSL port: </td><td id="pool_ssl_port"></td></tr> -->
                        <!-- <tr><td data-label="Allow self-select">Allow self-select: </td><td id="allow_self_select"></td></tr> -->
                        <tr><td data-label="Payouts">Payouts: </td><td>PPLNS</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="fluid col-sm">
                <table class="striped" style="max-height: 8000px; overflow: hidden">
                    <caption class="poolcol"><span id="aux_name">Aux</span></caption>
                    <tbody>
                        <tr><td data-label="Network hashrate">Network hashrate: </td><td id="aux_network_hashrate"></td></tr>
                        <tr><td data-label="Network height">Network height: </td><td id="aux_network_height"></td></tr>
                        <tr><td data-label="Block reward">Block reward: </td><td id="aux_block_reward"></td></tr>
                        <tr><td data-label="Blocks found">Blocks found: </td><td id="pool_aux_blocks_found"></td></tr>
                        <tr><td data-label="Last block found">Last block found: </td><td id="last_aux_block_found"></td></tr>
                        <!-- <tr><td data-label="Round hashrate">Round hashrate: </td><td id="aux_round_hashrate"></td></tr> -->
                        <tr><td data-label="Round hashes">Round hashes: </td><td id="aux_round_hashes"></td></tr>
                        <tr><td data-label="Payment threshold">Payment threshold: </td><td id="aux_payment_threshold"></td></tr>
                        <tr><td data-label="Miners connected">Miners connected: </td><td id="aux_connected_miners"></td></tr>
                    </tbody>
                </table>
            </div>
            <div class="fluid col-sm">
                <table class="striped" style="max-height: 8000px; overflow: hidden">
                    <caption class="poolcol">Monero</caption>
                    <tbody>
                        <tr><td data-label="Network hashrate">Network hashrate: </td><td id="network_hashrate"></td></tr>
                        <tr><td data-label="Network height">Network height: </td><td id="network_height"></td></tr>
                        <tr><td data-label="Block reward">Block reward: </td><td id="block_reward"></td></tr>
                        <tr><td data-label="Blocks found">Blocks found: </td><td id="pool_blocks_found"></td></tr>
                        <tr><td data-label="Last block found">Last block found: </td><td id="last_block_found"></td></tr>
                        <!-- <tr><td data-label="Round hashrate">Round hashrate: </td><td id="round_hashrate"></td></tr> -->
                        <tr><td data-label="Round hashes">Round hashes: </td><td id="round_hashes"></td></tr>
                        <tr><td data-label="Payment threshold">Payment threshold: </td><td id="payment_threshold"></td></tr>
                        <tr><td data-label="Miners connected">Miners connected: </td><td id="connected_miners"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="input-group fluid">
            <label for="username">Your address:</label>
            <input type="text" id="Username" placeholder="Townforge or Monero address" onKeyPress="if (event.keyCode == 13) js:set_miner_address(this); "/>
        </div>
        <div class="row">
            <div class="card small miner">
                <div class="section">
                    <h4 class="doc">Hash rate</h4>
                    <p class="doc"> <span id="miner_hashrate"> </span> </p>
                </div>
            </div>
            <div class="card small miner">
                <div class="section">
                    <h4 class="doc">Pending balance</h4>
                    <p class="doc"> <span id="miner_balance"> </span></p>
                </div>
            </div>
            <div class="card small miner">
                <div class="section">
                    <h4 class="doc">Workers</h4>
                    <p class="doc"> <span id="miner_workers"> </span> </p>
                </div>
            </div>
            <div class="card small miner">
                <div class="section">
                    <h4 class="doc">Hashes submitted</h4>
                    <p class="doc"> <span id="miner_hashes"> </span> </p>
                </div>
            </div>
        </div>

        <small><a href="https://github.com/jtgrassie/monero-pool">https://github.com/jtgrassie/monero-pool</a></small>
        <script>
            function format_last_time(last)
            {
                var now = new Date().getTime() / 1000;
                var diff = now - last;
                var v;
                if (last == 0)
                    return "None yet";
                else if (diff <= 0)
                    return "Just now";
                else if (diff < 60)
                {
                    v = parseInt(diff);
                    return v + " second" + (v != 1 ? "s" : "") + " ago";
                }
                else if (diff < 3600)
                {
                    v = parseInt(diff/60);
                    return v + " minute" + (v != 1 ? "s" : "") + " ago";
                }
                else if (diff < 86400)
                {
                    v = parseInt(diff/3600);
                    return v + " hour" + (v != 1 ? "s" : "") + " ago";
                }
                else
                {
                    v = parseInt(diff/86400);
                    return v + " day" + (v != 1 ? "s" : "") + " ago";
                }
            }

            function max_precision(n, p)
            {
                return parseFloat(parseFloat(n).toFixed(p));
            }

            function format_hashes(h)
            {
                if (h < 1e-12)
                    return "0 H";
                else if (h < 1e-9)
                    return max_precision(h*1e+12, 0) + " pH";
                else if (h < 1e-6)
                    return max_precision(h*1e+9, 0) + " nH";
                else if (h < 1e-3)
                    return max_precision(h*1e+6, 0) + " μH";
                else if (h < 1)
                    return max_precision(h*1e+3, 0) + " mH";
                else if (h < 1e+3)
                    return parseInt(h) + " H";
                else if (h < 1e+6)
                    return max_precision(h*1e-3, 2) + " kH";
                else if (h < 1e+9)
                    return max_precision(h*1e-6, 2) + " MH";
                else
                    return max_precision(h*1e-9, 2) + " GH";
            }

            function format_hashrate(h)
            {
                return format_hashes(h) + "/s";
            }

            function format_round_hashrate(round_hashes, last_block_found)
            {
                var now = new Date().getTime() / 1000;
                var diff = now - last_block_found;
                if (last_block_found == 0)
                    return 0;
                if (diff <= 0)
                    return 0;
                return format_hashrate(round_hashes / diff);
            }

            var wf = document.querySelector("#Username");
            var xhr = new XMLHttpRequest();
            var rhr = document.querySelector("#round_hashrate");
            var rhr2 = document.querySelector("#aux_round_hashrate");

            xhr.onload = function()
            {
                var stats = JSON.parse(xhr.responseText);
                for (var e in stats)
                {
                  var els = document.querySelectorAll("#"+e);
                  for (var i = 0; i < els.length; i += 1)
                  {
                    var el = els[i]
                    if (!el)
                        continue;
                    if (/^last/.test(e))
                        el.innerHTML = format_last_time(stats[e]);
                    else if (/hashrate/.test(e))
                        el.innerHTML = format_hashrate(stats[e]);
                    else if (e == "pool_fee")
                        el.innerHTML = (stats[e]*100) + "%";
                    else if (e == "allow_self_select")
                        el.innerHTML = stats[e] == 1 ? "Yes" : "No";
                    else if (e == "round_hashes")
                    {
                        if (stats["aux_network_difficulty"] != 0)
                        {
                            el.innerHTML = max_precision(stats[e]*100 /
                                stats["network_difficulty"], 1) + "%";
                            if (rhr)
                                rhr.innerHTML = format_round_hashrate(
                                    stats["round_hashes"], stats["last_block_found"]);
                        }
                    }
                    else if (e == "aux_round_hashes")
                    {
                        if (stats["aux_network_difficulty"] != 0)
                        {
                            el.innerHTML = max_precision(stats[e]*100 /
                                stats["aux_network_difficulty"], 1) + "%";
                            if (rhr2)
                                rhr2.innerHTML = format_round_hashrate(
                                    stats["aux_round_hashes"], stats["last_aux_block_found"]);
                        }
                    }
                    else if (e == "pool_ssl_port")
                    {
                        el.closest("tr").style = "display: " +
                            (stats[e] == 0 ? "none;" : "table-row;");
                        el.innerHTML = stats[e];
                    }
                    else
                        el.innerHTML = stats[e];
                  }
                }
            };

            function set_miner_address(e)
            {
                var d = new Date();
                d.setTime(d.getTime() + (86400 * 365 * 1000));
                document.cookie = "wa=" + e.value +
                    ";expires=" + d.toGMTString();
                window.location.reload();
                return false;
            };

            wf.onblur = function(e)
            {
                set_miner_address(wf);
            }

            window.onload = function()
            {
                var m = document.querySelectorAll(".miner");
                for (var i=0; i<m.length; i++)
                {
                    m[i].style = "display: none;";
                }
                var jar = {};
                for (var kv, i=0, kvs=document.cookie.split(/\s*;\s*/); i<kvs.length; i++)
                {
                    kv = kvs[i].split(/\s*=\s*/);
                    if (kv.length > 1)
                    {
                        try {
                            jar[kv[0]] = kv[1];
                        } catch (e) {}
                    }
                }
                if (jar.wa !== "undefined" && jar.wa &&
                    /^[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz]+$/.test(jar.wa))
                {
                    for (var i=0; i<m.length; i++)
                    {
                        m[i].style = "display: block;";
                    }
                    wf.value = jar.wa;
                }
                var get_stats = function()
                {
                    xhr.open("GET", "/stats");
                    xhr.send(null);
                };
                setInterval(get_stats, 30000);
                get_stats();
            };
        </script>
    </body>
</html>
